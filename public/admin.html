<!DOCTYPE html>
<html lang="hi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Business CRM - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root {
      --green: #25D366;
      --green-dark: #128C7E;
      --green-light: #DCF8C6;
      --bg: #f8fafc;
      --white: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --accent: #075E54;
      --danger: #ef4444;
      --warning: #f59e0b;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Baloo 2', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--accent) 0%, var(--green-dark) 60%, var(--green) 100%);
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 36px;
      height: 36px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--accent);
      font-weight: 800;
    }

    .header h1 {
      color: white;
      font-size: 18px;
      font-weight: 800;
    }

    .header h1 span {
      color: var(--green-light);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* DASHBOARD TOP BAR */
    .dashboard-bar {
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }

    .stats-container {
      display: flex;
      gap: 12px;
    }

    .stat-card {
      background: var(--bg);
      padding: 8px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-width: 100px;
    }

    .stat-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-light);
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 800;
      color: var(--accent);
    }

    .stat-value.mature {
      color: var(--green-dark);
    }

    .stat-value.new {
      color: var(--warning);
    }

    .filter-bar {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-light);
    }

    .header-input {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: 'Baloo 2', sans-serif;
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
    }

    .header-input:focus {
      border-color: var(--green);
    }

    /* TWO COLUMN LAYOUT */
    .admin-main {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      overflow: hidden;
      height: calc(100vh - 128px);
      /* Adjust based on header + dashboard bar */
      padding: 16px;
    }

    .admin-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .column-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fcfdfe;
    }

    .column-header h2 {
      font-size: 16px;
      font-weight: 800;
      color: var(--accent);
    }

    .column-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* CARDS */
    .lead-card {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: white;
      transition: all 0.2s;
      position: relative;
    }

    .lead-card:hover {
      border-color: var(--green);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .lead-card.mature-card {
      border-left: 4px solid var(--green);
      background: #f0fff4;
    }

    .card-name {
      font-weight: 800;
      font-size: 14px;
      color: var(--accent);
      margin-bottom: 2px;
    }

    .card-phone {
      font-size: 12px;
      color: var(--text-light);
      font-weight: 600;
    }

    .card-details {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
      line-height: 1.4;
    }

    .card-actions {
      margin-top: 10px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 7px 12px;
      border: none;
      border-radius: 8px;
      font-family: 'Baloo 2', sans-serif;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--green-dark);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn:hover {
      background: var(--accent);
      transform: scale(1.02);
    }

    .btn-ghost {
      background: #f1f5f9;
      color: var(--text-light);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: #e2e8f0;
      border-color: #cbd5e1;
    }

    .btn-mini {
      padding: 4px 8px;
      font-size: 11px;
    }

    select.form-select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-family: 'Baloo 2', sans-serif;
      outline: none;
      background: #f8fafc;
    }

    /* UTILS */
    .wa-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .wa-status.connected {
      background: rgba(37, 211, 102, 0.15);
      color: #fff;
      border-color: var(--green);
    }

    .wa-status.disconnected {
      background: rgba(239, 68, 68, 0.15);
      color: #fff;
      border-color: #ef4444;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
    }

    .connected .status-dot {
      background: var(--green);
      animation: blink 1.5s infinite;
    }

    .disconnected .status-dot {
      background: #ef4444;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.3
      }
    }

    .logout-btn {
      padding: 5px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* OVERLAYS */
    .modal-overlay,
    .login-overlay,
    .qr-overlay,
    .audit-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 500;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.show,
    .login-overlay.show,
    .qr-overlay.show,
    .audit-overlay.show {
      display: flex;
    }

    .modal-box,
    .login-box,
    .qr-box,
    .audit-box {
      background: white;
      border-radius: 20px;
      padding: 24px;
      width: 400px;
      max-width: 90vw;
      box-shadow: var(--shadow-lg);
      position: relative;
      animation: popIn 0.3s ease;
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.9)
      }

      to {
        opacity: 1;
        transform: scale(1)
      }
    }

    .login-box h2,
    .qr-box h2,
    .audit-box h2,
    .modal-box h2 {
      font-size: 18px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 16px;
      text-align: center;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 12px;
    }

    .form-group label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-light);
      text-transform: uppercase;
    }

    .login-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 8px;
      text-align: center;
      min-height: 16px;
    }

    #qrCanvas {
      display: block;
      margin: 15px auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .grid {
      display: grid;
      gap: 10px;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
      display: none;
    }

    .toast.show {
      display: block;
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.success {
      background: var(--green-dark);
    }

    .muted {
      color: var(--text-light);
      font-size: 12px;
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>Admin Login</h2>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="admin@example.com" class="header-input">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="header-input">
      </div>
      <button class="btn" onclick="login()" style="width:100%; justify-content:center">Login</button>
      <div class="login-error" id="loginError"></div>
    </div>
  </div>

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="logo">A</div>
      <h1>Admin <span>Panel</span></h1>
    </div>
    <div class="header-actions">
      <div class="stat-pill" id="userPill" style="display:none; color:white; font-size:12px; font-weight:700">User:
        <span id="userName">-</span>
      </div>
      <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display:none">Logout</button>
      <div class="wa-status disconnected" id="waStatusBtn" onclick="toggleQR()">
        <div class="status-dot"></div>
        <span id="waStatusText">WhatsApp Connect</span>
      </div>
    </div>
  </div>

  <!-- QR MODAL -->
  <div class="qr-overlay" id="qrOverlay">
    <div class="qr-box" id="qrBox">
      <h2>WhatsApp Connect</h2>
      <p class="muted">QR scan karke WhatsApp connect karo</p>
      <canvas id="qrCanvas"></canvas>
      <div style="margin-top:12px; text-align:center">
        <button class="btn btn-ghost" onclick="closeQR()">Close</button>
      </div>
    </div>
  </div>

  <div class="dashboard-bar">
    <div class="stats-container">
      <div class="stat-card">
        <span class="stat-label">Total Mature</span>
        <span class="stat-value mature" id="statMature">0</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Assigned</span>
        <span class="stat-value" id="statAssigned">0</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Unassigned</span>
        <span class="stat-value new" id="statUnassigned">0</span>
      </div>
    </div>

    <div class="filter-bar">
      <div class="filter-group">
        <label>Date:</label>
        <input type="date" id="filterDate" class="header-input" onchange="fetchPaginatedLeads()">
      </div>
      <div class="filter-group">
        <label>Agent:</label>
        <select id="filterAgent" class="header-input" onchange="fetchPaginatedLeads()">
          <option value="all">All Agents</option>
        </select>
      </div>
      <div class="filter-group">
        <input type="text" id="filterSearch" class="header-input" placeholder="Search Name/Phone..."
          oninput="fetchPaginatedLeads()">
      </div>
      <button class="btn btn-ghost" onclick="toggleSettingsModal()">‚öôÔ∏è Settings</button>
    </div>
  </div>

  <div class="admin-main">
    <!-- LEFT COLUMN: NEW / UNASSIGNED -->
    <div class="admin-column">
      <div class="column-header">
        <h2>üü° New Leads (Unassigned)</h2>
        <div class="row" id="bulkActions" style="display:none; gap:10px; align-items:center">
          <button class="btn btn-mini btn-ghost" style="color:var(--danger)" onclick="bulkDelete()">Delete</button>
          <select id="bulkAssignSelect" class="form-select"></select>
          <button class="btn btn-mini" onclick="bulkAssign()">Assign</button>
        </div>
      </div>
      <div class="column-scroll" id="unassignedColumn"></div>
    </div>

    <!-- MIDDLE COLUMN: ASSIGNED -->
    <div class="admin-column">
      <div class="column-header">
        <h2>‚úÖ Assigned Leads</h2>
        <span class="muted" id="assignedCount">0 leads</span>
      </div>
      <div class="column-scroll" id="assignedColumn"></div>
    </div>

    <!-- RIGHT COLUMN: MATURE -->
    <div class="admin-column">
      <div class="column-header">
        <h2>üü¢ Mature (Ordered)</h2>
        <span class="muted" id="matureCount">0 leads</span>
      </div>
      <div class="column-scroll" id="matureColumn"></div>
    </div>
  </div>

  <!-- PAGINATION -->
  <div
    style="display: flex; justify-content: center; gap: 15px; padding: 12px; background: white; border-top: 1px solid var(--border);">
    <button class="btn btn-ghost" id="btnPrevPage" onclick="changePage(-1)">‚óÄ Previous</button>
    <span style="font-size: 14px; font-weight: 700; color: var(--text); padding: 8px 0" id="pageIndicator">Page 1</span>
    <button class="btn btn-ghost" id="btnNextPage" onclick="changePage(1)">Next ‚ñ∂</button>
    <select id="limitSelect" class="form-select" onchange="changeLimit(this.value)">
      <option value="50">50 / page</option>
      <option value="100">100 / page</option>
      <option value="500">500 / page</option>
    </select>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal-box" style="width: 500px; max-height: 85vh; overflow-y: auto;">
      <h2>‚öôÔ∏è System Settings</h2>
      <div style="display: grid; gap: 24px;">
        <section>
          <h3 style="font-size:14px; margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:4px">
            Assignment Rule</h3>
          <div style="display:flex; gap:10px">
            <select id="assignmentRule" class="form-select" style="flex:1">
              <option value="manual">Manual</option>
              <option value="auto">Auto (Round Robin)</option>
              <option value="random">Random</option>
            </select>
            <button class="btn" onclick="saveRule()">Save</button>
          </div>
        </section>

        <section>
          <h3 style="font-size:14px; margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:4px">
            Business Focus</h3>
          <div style="display:flex; gap:10px">
            <select id="companyFocus" class="form-select" style="flex:1">
              <option value="product">Product Focus</option>
              <option value="service">Service Focus</option>
            </select>
            <button class="btn" onclick="saveFocus()">Save</button>
          </div>
        </section>

        <section>
          <h3 style="font-size:14px; margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:4px">
            Catalog</h3>
          <div style="display:flex; gap:10px; margin-bottom:12px">
            <input type="text" id="newCatalogName" class="header-input" style="flex:1" placeholder="Item Name">
            <input type="number" id="newCatalogPrice" class="header-input" style="width:80px" placeholder="Price">
            <button class="btn" onclick="addCatalogItem()">Add</button>
          </div>
          <div id="catalogList" class="grid"
            style="max-height:150px; overflow-y:auto; background:var(--bg); padding:8px; border-radius:8px"></div>
        </section>

        <section>
          <h3 style="font-size:14px; margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:4px">
            Create New User</h3>
          <div class="grid" style="gap:10px">
            <input type="text" id="newUserName" class="header-input" placeholder="Full Name">
            <input type="email" id="newUserEmail" class="header-input" placeholder="Email Address">
            <div style="display:flex; gap:10px">
              <input type="password" id="newUserPassword" class="header-input" style="flex:1" placeholder="Password">
              <select id="newUserRole" class="form-select">
                <option value="agent">Agent</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <button class="btn" onclick="createUser()" style="justify-content:center">Create User</button>
          </div>
        </section>

        <section>
          <h3 style="font-size:14px; margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:4px">
            Users</h3>
          <div id="usersList" class="grid" style="max-height:200px; overflow-y:auto"></div>
        </section>
      </div>
      <div style="margin-top:24px; text-align:center; border-top:1px solid var(--border); padding-top:16px">
        <button class="btn btn-ghost" onclick="toggleSettingsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <script>
    let customers = [];
    let users = [];
    let catalogItems = [];
    let companyFocus = 'product';
    let paginationState = { page: 1, limit: 50, total: 0, totalPages: 1 };
    let selectedUnassigned = new Set();
    let ws = null;
    let wsConnected = false;
    let waReady = false;
    let currentUser = null;

    // --- UTILS ---
    function showToast(msg, type = '') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast show ' + type;
      setTimeout(() => t.className = 'toast', 3000);
    }

    async function apiFetch(url, options = {}) {
      const res = await fetch(url, options);
      if (res.status === 401 || res.status === 403) {
        showLogin(true);
        return null;
      }
      return res;
    }

    function showLogin(show) {
      document.getElementById('loginOverlay').classList.toggle('show', !!show);
    }

    function toggleSettingsModal() {
      document.getElementById('settingsModal').classList.toggle('show');
    }

    // --- AUTH ---
    async function checkAuth() {
      try {
        const res = await fetch('/api/auth/me');
        if (res.ok) {
          const data = await res.json();
          if (data.user.role !== 'admin') {
            showToast('Admin access required', 'error');
            showLogin(true);
            return;
          }
          currentUser = data.user;
          document.getElementById('userPill').style.display = 'inline-flex';
          document.getElementById('userName').textContent = currentUser.name;
          document.getElementById('logoutBtn').style.display = 'inline-flex';
          showLogin(false);
          startApp();
        } else {
          showLogin(true);
        }
      } catch (e) { showLogin(true); }
    }

    async function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const err = document.getElementById('loginError');
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.success && data.user.role === 'admin') {
          location.reload();
        } else {
          err.textContent = data.error || 'Login failed';
        }
      } catch (e) { err.textContent = 'Server error'; }
    }

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST' });
      location.reload();
    }

    // --- DATA LOADING ---
    async function startApp() {
      connectWS();
      await loadUsers();
      await loadSettings();
      loadWhatsAppStatus();
      initFilterDate();
    }

    async function loadUsers() {
      const res = await apiFetch('/api/admin/users');
      if (!res) return;
      users = await res.json();
      const agents = users.filter(u => u.role === 'agent' && u.active);
      const filterAgent = document.getElementById('filterAgent');
      filterAgent.innerHTML = '<option value="all">All Agents</option>' +
        agents.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
      renderUsers();
      fetchPaginatedLeads();
    }

    async function loadSettings() {
      const res = await apiFetch('/api/admin/settings');
      if (!res || !res.ok) return;
      const data = await res.json();
      document.getElementById('assignmentRule').value = data.assignment_rule || 'manual';
      companyFocus = data.company_focus || 'product';
      document.getElementById('companyFocus').value = companyFocus;
      loadCatalog();
    }

    async function loadCatalog() {
      const res = await apiFetch(`/api/admin/catalog?type=${companyFocus}`);
      if (res && res.ok) {
        catalogItems = await res.json();
        renderCatalog();
      }
    }

    function initFilterDate() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      document.getElementById('filterDate').value = `${y}-${m}-${d}`;
    }

    // --- WEBSOCKET ---
    function connectWS() {
      ws = new WebSocket(`ws://${location.host}`);
      ws.onopen = () => { wsConnected = true; };
      ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === 'qr') showQRCode(data.qr);
        else if (data.type === 'ready') {
          updateWAStatus(true);
          closeQR();
        } else {
          fetchPaginatedLeads();
        }
      };
      ws.onclose = () => { wsConnected = false; setTimeout(connectWS, 3000); };
    }

    async function fetchPaginatedLeads() {
      const dateVal = document.getElementById('filterDate').value;
      const agentVal = document.getElementById('filterAgent').value;
      const searchVal = document.getElementById('filterSearch').value;

      const q = new URLSearchParams({
        page: paginationState.page,
        limit: paginationState.limit,
      });
      if (dateVal) q.append('date', dateVal);
      if (agentVal && agentVal !== 'all') q.append('agentId', agentVal);
      if (searchVal) q.append('search', searchVal);

      try {
        const res = await apiFetch(`/api/customers/paginated?${q.toString()}`);
        if (res && res.ok) {
          const json = await res.json();
          customers = json.data || [];
          paginationState = json.pagination;
          document.getElementById('pageIndicator').textContent = `Page ${paginationState.page} of ${paginationState.totalPages || 1} (${paginationState.total} total)`;
          document.getElementById('btnPrevPage').disabled = paginationState.page <= 1;
          document.getElementById('btnNextPage').disabled = paginationState.page >= paginationState.totalPages;
          renderAll();
        }
      } catch (e) { console.error(e) }
    }

    function changePage(delta) {
      paginationState.page = Math.max(1, paginationState.page + delta);
      fetchPaginatedLeads();
    }

    function changeLimit(val) {
      paginationState.limit = parseInt(val) || 50;
      paginationState.page = 1;
      fetchPaginatedLeads();
    }

    // --- RENDERING ---
    function renderAll() {
      const unassigned = customers.filter(c => !c.assigned_user_id);
      const assigned = customers.filter(c => c.assigned_user_id && !c.mature);
      const mature = customers.filter(c => c.mature);

      renderColumn('unassignedColumn', unassigned, true);
      renderColumn('assignedColumn', assigned);
      renderColumn('matureColumn', mature);

      document.getElementById('assignedCount').textContent = `${assigned.length} leads`;
      document.getElementById('matureCount').textContent = `${mature.length} leads`;
      document.getElementById('statUnassigned').textContent = unassigned.length;
      document.getElementById('statAssigned').textContent = assigned.length;
      document.getElementById('statMature').textContent = mature.length;
    }

    function getAgentName(id) {
      const u = users.find(x => x.id === id);
      return u ? u.name : 'Unknown';
    }

    function renderColumn(id, leads, isUnassigned = false) {
      const container = document.getElementById(id);
      if (leads.length === 0) {
        container.innerHTML = '<div class="muted" style="text-align:center;padding:40px">No leads found</div>';
        return;
      }

      container.innerHTML = leads.map(c => `
        <div class="lead-card ${c.mature ? 'mature-card' : ''}">
          <div class="card-name">${c.name}</div>
          <div class="card-phone">üì± ${c.phone}</div>
          <div class="card-details">${c.assigned_user_id ? 'Agent: ' + getAgentName(c.assigned_user_id) : 'Unassigned'}</div>
          ${isUnassigned ? `
            <div class="card-actions">
              <select class="form-select" onchange="assignLead(${c.id}, this.value)">
                <option value="">Assign to...</option>
                ${users.filter(u => u.role === 'agent' && u.active).map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
              </select>
            </div>
          ` : ''}
          <div class="card-actions">
            <button class="btn btn-ghost btn-mini" style="color:var(--danger)" onclick="deleteLead(${c.id})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function renderUsers() {
      const list = document.getElementById('usersList');
      list.innerHTML = users.map(u => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee">
          <div>
            <div style="font-weight:700; font-size:13px">${u.name} (${u.role})</div>
            <div class="muted">${u.email}</div>
          </div>
          <button class="btn btn-mini ${u.active ? 'btn-ghost' : ''}" onclick="toggleUserStatus(${u.id})">${u.active ? 'Disable' : 'Enable'}</button>
        </div>
      `).join('');
    }

    function renderCatalog() {
      const list = document.getElementById('catalogList');
      list.innerHTML = catalogItems.map(item => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:6px; border-bottom:1px solid #eee">
          <span style="font-size:13px">${item.name} - ‚Çπ${item.price}</span>
          <button class="btn btn-mini btn-ghost" style="color:var(--danger)" onclick="deleteCatalogItem(${item.id})">Delete</button>
        </div>
      `).join('');
    }

    // --- ACTIONS ---
    async function assignLead(customerId, userId) {
      if (!userId) return;
      const res = await apiFetch('/api/admin/assign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerId, userId })
      });
      if (res && res.ok) {
        showToast('Assigned successfully', 'success');
        fetchPaginatedLeads();
      }
    }

    async function deleteLead(id) {
      if (!confirm('Delete this lead?')) return;
      const res = await apiFetch(`/api/customers/${id}`, { method: 'DELETE' });
      if (res && res.ok) {
        showToast('Lead deleted', 'success');
        fetchPaginatedLeads();
      }
    }

    async function toggleUserStatus(id) {
      const res = await apiFetch(`/api/admin/users/${id}/toggle`, { method: 'POST' });
      if (res && res.ok) loadUsers();
    }

    async function saveRule() {
      const rule = document.getElementById('assignmentRule').value;
      const res = await apiFetch('/api/admin/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assignment_rule: rule })
      });
      if (res && res.ok) showToast('Settings saved', 'success');
    }

    async function saveFocus() {
      const focus = document.getElementById('companyFocus').value;
      const res = await apiFetch('/api/admin/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ company_focus: focus })
      });
      if (res && res.ok) {
        companyFocus = focus;
        loadCatalog();
        showToast('Focus updated', 'success');
      }
    }

    async function addCatalogItem() {
      const name = document.getElementById('newCatalogName').value.trim();
      const price = parseFloat(document.getElementById('newCatalogPrice').value) || 0;
      if (!name) return;
      const res = await apiFetch('/api/admin/catalog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, type: companyFocus, price })
      });
      if (res && res.ok) {
        document.getElementById('newCatalogName').value = '';
        document.getElementById('newCatalogPrice').value = '';
        loadCatalog();
        showToast('Item added', 'success');
      }
    }

    async function deleteCatalogItem(id) {
      const res = await apiFetch(`/api/admin/catalog/${id}`, { method: 'DELETE' });
      if (res && res.ok) loadCatalog();
    }

    async function createUser() {
      const name = document.getElementById('newUserName').value.trim();
      const email = document.getElementById('newUserEmail').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;
      if (!name || !email || !password) return showToast('Fill all fields', 'error');

      const res = await apiFetch('/api/admin/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, password, role })
      });
      if (res && res.ok) {
        showToast('User created', 'success');
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserPassword').value = '';
        loadUsers();
      }
    }

    // --- WHATSAPP ---
    function updateWAStatus(ready) {
      waReady = ready;
      const btn = document.getElementById('waStatusBtn');
      btn.className = 'wa-status ' + (ready ? 'connected' : 'disconnected');
      document.getElementById('waStatusText').textContent = ready ? 'WhatsApp Connected' : 'WhatsApp Connect';
    }

    async function loadWhatsAppStatus() {
      const res = await fetch('/api/whatsapp/status');
      if (res.ok) {
        const data = await res.json();
        updateWAStatus(!!data.ready);
      }
    }

    function toggleQR() {
      document.getElementById('qrOverlay').classList.add('show');
      if (wsConnected) ws.send(JSON.stringify({ type: 'get_qr' }));
    }

    function closeQR() { document.getElementById('qrOverlay').classList.remove('show'); }

    function showQRCode(qrString) {
      const canvas = document.getElementById('qrCanvas');
      QRCode.toCanvas(canvas, qrString, { width: 220, margin: 2 });
    }

    window.onload = checkAuth;
  </script>
</body>

</html>